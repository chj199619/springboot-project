/*! mini-cart 2016-07-04 09:21:52 */
KISSY.add("tb/mini-cart",function(a,b){var c=TB.Global,d="hover",e="mini-cart-";"2.0"===c.version&&(d="g_head-menu-hover",e="mini-cart-");var f=window,g=document,h=!"0"[0],i=h&&!window.XMLHttpRequest,j=g.domain,k=!(j.indexOf("taobao.com")>-1||j.indexOf("tmall.com")>-1||j.indexOf("jiyoujia.com")>-1),l=k?".daily.taobao.net":".taobao.com",m="//cart"+l+"/",n=m+"trail_mini_cart.htm?",o=m+"del_mini_cart.htm?",p="\u6b63\u5728\u5220\u9664\u4e2d",q="\u5220\u9664",r=e,s=r+"bd",t=r+"img",u=r+"count",v=r+"del",w=r+"title",x=r+"info",y=r+"ft",z=r+"price h",A=r+"ready",B="data-cartId",C=".",D="",E=function(a){var b=a.match(/&#[0-9]{1,5};/g);if(null!=b){var c,d,e;for(e=0;e<b.length;e++)c=b[e],d=c.substring(2,c.length-1),a=d>=-32768&&d<=65535?a.replace(c,String.fromCharCode(d)):a.replace(c,"")}return a.replace("<","&lt;").replace(">","&gt;")},F=function(a){if(a.css({"white-space":"nowrap",overflow:"hidden"}),"textOverflow"in g.documentElement.style||"OTextOverflow"in g.documentElement.style)a.css({"text-overflow":"ellipsis","-o-text-overflow":"ellipsis"});else{a.data("text")||a.data("text",a.text());var c=a.attr("text")||a.text(),d=a.width(),e=0,f=c.length,h=f,i=new b(a[0].cloneNode(!0)).insertAfter(a);if(a.text(c),i.text(c).css({position:"absolute",width:"auto",visibility:"hidden",overflow:"hidden"}),i.width()>d){for(;(h=Math.floor((f+e)/2))>e;)i.text(c.substr(0,h)+"\u2026"),i.width()>d?f=h:e=h;a.text(c.substr(0,h)+"\u2026"),a.attr("title")||a.attr("title",c)}i.remove()}},G=function(){},H="\u60a8\u8d2d\u7269\u8f66\u91cc\u8fd8\u6ca1\u6709\u4efb\u4f55\u5b9d\u8d1d\u3002",I="\u7cfb\u7edf\u76ee\u524d\u7e41\u5fd9\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002",J="\u60a8\u8d2d\u7269\u8f66\u91cc\u7684\u5b9d\u8d1d\u5747\u5df2\u5931\u6548\u3002";f.MiniCart={init:function(a,b,c){var d=this;a=parseInt(a),isNaN(a)||a<0||(d.cartNum=a,b&&(c&&c(b),d._rendUI(),d.render()))},reset:function(){this._data=null,this._isRequesting=!1,this.isExpired=!0,this._rendUI()},_rendUI:function(){var a=this;a.trigger=b.one("#J_MiniCart"),a.elem=b.one("#mc-menu-hd"),a.content=a.trigger.one(".menu-bd-panel"),a._bindUI()},_bindUI:function(){var c=this,d=c.content;d.on("click",function(c){if(!TB.Global._OFF){var d,e=new b(c.target);if("a"===e[0].tagName.toLowerCase()&&(d=e.parent(),d.hasClass(v))){if(c.preventDefault(),c.halt(),e.html()===p)return;G("delete"),e.html(p),a.getScript(o+"callback=MiniCart.remove&del_id="+d.parent().attr(B)+"&t="+a.now(),function(){e.html(q),this.parentNode.removeChild(this)})}}})},remove:function(c){var d=this;if(c)if(c.status){var e=d.content,f=e.one(C+s);a.each(f.children(),function(a){if(a=new b(a),a.attr(B)==c.delCart){var e=function(){a.remove?a.remove():a[0].parentNode.removeChild(a[0]),d.setData(c),0===d.cartNum&&d.hide()};return i?e():a.animate?a.animate("opacity: 0",1,"easeOut",e):e(),!1}})}else alert(c.errMsg)},render:function(){var b=this,c=b.content,d=function(a){b.setData({status:!1,errMsg:a})};if(b._isRequesting=!1,(!b._data||b.isExpired)&&!b._isRequesting&&c){if(c.html(D).removeClass(A),b.cartNum<1)return d(H),void c.addClass(A);b._isRequesting=!0,a.later(function(){!b._clicked&&b._isShowing()&&(a.getScript(n+"callback=MiniCart.setData&t="+a.now(),function(){c.addClass(A),this.parentNode.removeChild(this)}),b._setTimeout(function(){d(I)}))},300)}},show:function(){this.render(),this.trigger.addClass("menu-hover")},hide:function(){var b=this;a.later(function(){b.trigger.removeClass(d)},2e3)},_isShowing:function(){return"block"===this.content.css("display")},_parseItem:function(b){var c=this,d=D,e=b.item,f=e?e.length:0,g=0;return f>0&&(g=b.num-f,window.period=parseInt(b.period,10),d+='<div class="mini-cart-hd"><strong>\u6700\u8fd1\u52a0\u5165\u7684\u5b9d\u8d1d\uff1a</strong></div><ul class="mini-cart-bd">',a.each(e,function(a){var b="//item"+l+"/item.htm?id="+a.itemId,c=E(a.title);d+="<li "+B+'="'+a.cartId+'"><div class="'+t+'"><a target="_top" href="'+b+'"><img src="'+a.picUrl+'" alt="'+c+'" /></a></div><div class="'+u+'" style="font-family: Arial;">'+(a.currency?a.currency:"&yen;")+'<strong class="'+z+'">'+a.price+'</strong></div><div class="'+w+'"><a target="_top" href="'+b+'" title="'+c+'">'+c+'</a></div><div class="'+v+'"><a href="#">\u5220\u9664</a></div>'+(a.sku&&a.sku.length?'<div class="'+x+'"><span>'+a.sku.join("</span><span>")+"</span></div>":D)+(a.prefence?'<span class="flag-1111"></span>':"")+"</li>"}),d+="</ul>"),g>0&&(d+='<div class="'+y+'"><p><strong>'+c._parseRest(g,b.num)+"</strong></p></div>"),d},_parseRest:function(a){return a>0&&a<45?"\u8d2d\u7269\u8f66\u91cc\u8fd8\u6709"+a+"\u4ef6\u5b9d\u8d1d":D},_parseMsg:function(a){var b=D;return b+='<div class="'+y+'">'+(a&&a!==H?"<p>"+a+"</p>":D)+"<p>"+(a===H?a:D)+'<a target="_top" href="//cart'+l+'/my_cart.htm?from=mini&ad_id=&am_id=&cm_id=&pm_id=150042785330be233161" class="site-nav-btn">\u67e5\u770b\u6211\u7684\u8d2d\u7269\u8f66</a></p></div>'},_setTimeout:function(b){var c=this;c._timeout||(c._timeout=a.later(function(){b(),c._timeout=void 0},1e4))},_clearTimeout:function(){var a=this;a._timeout&&a._timeout.cancel(),a._timeout=void 0},off:function(){this.content.html(this._parseMsg(""))},setData:function(d){var e=this,f=D,g=e.content;if(e._clearTimeout(),d){if(d.status){var h=d.num,i=!1;if(a.isNumber(h)&&h===-2&&(h=e.cartNum-1,i=!0),TB.Global.setCartNum(h),e._data=d,h>0)if(d.item&&d.item.length)f=e._parseItem(d)+e._parseMsg(D);else if(i){var j=g.one(C+y),k=g.one(C+s).all("li").length;k?(j&&j.html(e._parseRest(h-k,h)),f=g.html()):(f=e._parseMsg(j?J:H),e.hide())}else"false"===d.isLogin?(f=e._parseMsg(""),e.hide()):(f=e._parseMsg(J),e.hide());else 0===h&&(f=e._parseMsg(H));e.isExpired=!1,setTimeout(function(){e.isExpired=!0},3e4)}else f=e._parseMsg(d.errMsg);if(d.num!==-1){g.html(f);var l=g.prev("iframe");l&&l.offset(g.offset()).width(g.width()+30).height(g.height()+20),c.use&&c.use("fn-core",function(a,b){b.iframeShim(a.util.$("J_MiniCart"),!0)}),a.each(b.all(C+w),function(a){a=new b(a);var c=280-a.prev(C+u).width()-70,d=a.one("a");d.width(c),F(d)})}}}}},{requires:["node"]});